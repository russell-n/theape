<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The SSH Connection &mdash; The Ape 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="The Ape 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Client Connections" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Ape Documentation</a> &raquo;</li>
          <li><a href="../index.html" >Parts</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Client Connections</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-ssh-connection">
<h1>The SSH Connection<a class="headerlink" href="#the-ssh-connection" title="Permalink to this headline">¶</a></h1>
<p id="ssh-connection">This is the workhorse connection built around the <cite>paramiko</cite> SSHClient. Updates in paramiko&#8217;s interface as well as a better understanding of how it works has lead me to re-start it as the basis for the other connection types. The main way to use it is meant to be with dot-notation. To do <tt class="docutils literal"><span class="pre">ls</span> <span class="pre">-a</span></tt> for instance, you would do something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">connection</span> <span class="o">=</span> <span class="n">SSHConnection</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s">&#39;someip&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;tester&#39;</span><span class="p">)</span>
<span class="n">opened_files</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opened_files</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span>
</pre></div>
</div>
<p>This assumes you have your public keys set up, otherwise you would need to pass in the password to the constructor.</p>
<p>Sometimes people create commands as files with extensions (e.g. <tt class="docutils literal"><span class="pre">wifi.sh</span></tt>) which will mess up the dot-notation, in that case you can pass in the whole thing as a string by calling the connection:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">opened_files</span> <span class="o">=</span> <span class="n">connection</span><span class="p">(</span><span class="s">&#39;wifi.sh -h&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opened_files</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opened_files</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span>
</pre></div>
</div>
<p>I have also aliased the call with <tt class="docutils literal"><span class="pre">exec_command</span></tt> so that code that is expecting a paramiko SSHClient can still use it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">&#39;iperf -s&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is also a <tt class="docutils literal"><span class="pre">sudo</span></tt> method to let you run something as root:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">in_out_error</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="s">&#39;nmap -sS &quot;192.168.10.*&quot;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;testlabs&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">in_out_error</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span>
</pre></div>
</div>
<p>This is the equivalent of:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">in_out_error</span> <span class="o">=</span> <span class="n">connection</span><span class="p">(</span><span class="s">&#39;sudo nmap -sS &quot;192.168.10.*&quot;&#39;</span><span class="p">,</span> <span class="n">get_pty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">in_out_error</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;testlabs&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">in_out_error</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span>
</pre></div>
</div>
<p>But I figured it&#8217;s such a rare thing that I wouldn&#8217;t be able to remember how to do it when I needed it.</p>
<p>There&#8217;s also a lock so that if multiple pieces of code are using the same connection they can be thread-safe:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
    <span class="n">in_out_error</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s">&#39;/proc/cpuinfo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I&#8217;ve integrated a lock into the calls to <tt class="docutils literal"><span class="pre">exec_command</span></tt> so that it will always be thread-safe (although I think it&#8217;s better to use multiple clients when possible instead of sharing one instance). This means that you shouldn&#8217;t need to use the lock as shown above. Using the lock can introduce waiting time for users of the shared client and will make them more brittle (one dead client will kill all the threads using it) so it is only meant to test cases where the device seems to be having trouble with multiple ssh-sessions.</p>
</div>
<span class="target" id="module-theape.clients.sshconnection"></span><table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection</span></tt></td>
<td></td>
</tr>
<tr class="row-even"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection.client</span></tt></td>
<td></td>
</tr>
<tr class="row-odd"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection.sudo</span></tt></td>
<td></td>
</tr>
<tr class="row-even"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection.__call__</span></tt></td>
<td></td>
</tr>
<tr class="row-odd"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection.close</span></tt></td>
<td></td>
</tr>
<tr class="row-even"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection.__getattr__</span></tt></td>
<td></td>
</tr>
<tr class="row-odd"><td><tt class="xref py py-obj docutils literal"><span class="pre">SSHConnection.lock</span></tt></td>
<td></td>
</tr>
</tbody>
</table>
<p class="plantuml">
<img src="../../_images/plantuml-6ae40a198ccdecbff42beb404713963d9d845044.png" alt="SSHConnection -|&gt; BaseClass
SSHConnection o-- paramiko.SSHClient
SSHConnection o-- SocketStorage
SSHConnection : sudo(command, password, [timeout=None])
SSHConnection : __call__(command, [timeout=None, [get_pty=False]])
SSHConnection : exec_command(command, [timeout=None, [get_pty=False]])
SSHConnection : __getattr__(command, [timeout, [get_pty=False]])
SSHConnection o-- threading.RLock" />
</p>
<div class="section" id="the-sshclient">
<span id="ape-sshconnection-client"></span><h2>The SSHClient<a class="headerlink" href="#the-sshclient" title="Permalink to this headline">¶</a></h2>
<p>Behind the scenes this is mostly a thin adapter for the SSHClient.</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="api/paramiko.client.SSHClient.html#paramiko.client.SSHClient" title="paramiko.client.SSHClient"><tt class="xref py py-obj docutils literal"><span class="pre">SSHClient</span></tt></a>()</td>
<td>A high-level representation of a session with an SSH server.</td>
</tr>
</tbody>
</table>
<p>And the methods are versions of the <cite>exec_command</cite>.</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="api/paramiko.client.SSHClient.exec_command.html#paramiko.client.SSHClient.exec_command" title="paramiko.client.SSHClient.exec_command"><tt class="xref py py-obj docutils literal"><span class="pre">SSHClient.exec_command</span></tt></a>(command[,&nbsp;bufsize,&nbsp;...])</td>
<td>Execute a command on the SSH server.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="the-inouterror-named-tuple">
<span id="ape-sshconnection-inouterror"></span><h2>The InOutError Named Tuple<a class="headerlink" href="#the-inouterror-named-tuple" title="Permalink to this headline">¶</a></h2>
<p>To help prevent the mixing up of the different files returned (stdout, stdin, and stderr (not necessarily in that order)) the SSHConnection will returned a named tuple.</p>
<p class="plantuml">
<img src="../../_images/plantuml-d20526ba87d4f46cc2304ad53f9799025c91af89.png" alt="InOutError -|&gt; collections.namedtuple
InOutError : Storage input
InOutError : Storage output
InOutError : Storage error" />
</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The SSH Connection</a><ul>
<li><a class="reference internal" href="#the-sshclient">The SSHClient</a><ul>
</ul>
</li>
<li><a class="reference internal" href="#the-inouterror-named-tuple">The InOutError Named Tuple</a></li>
</ul>
</li>
</ul>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/user/index.html">User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/developer/index.html">Developer Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../log_setter.html">Log Setter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">The Main Entry Point</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">The APE (Read Me)</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../components/index.html">The Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">The Ape&#8217;s Infrastructure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Parts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014, the cloistered monkey.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.6.2</a>
      
      |
      <a href="../../_sources/parts/connections/sshconnection.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>